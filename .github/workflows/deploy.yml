name: Deployment CI/CD

# This action runs on every push to the main branch
on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    # The type of virtual machine that the job will run on
    runs-on: ubuntu-latest

    steps:
      # Step 1: Check out the repository code so the workflow can access it
      - name: Checkout Code
        uses: actions/checkout@v4

      # -----------------------------------------------------------------
      # CI: Continuous Integration - Build and test the code
      # -----------------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          # Use the same Python version that you use in production
          python-version: '3.12' 

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # -----------------------------------------------------------------
      # CD: Continuous Deployment - Deploy to VPS
      # -----------------------------------------------------------------
      - name: Deploy to VPS
        if: success()
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          script: |
            # Navigate to the project directory on your VPS
            cd ${{ secrets.PROJECT_PATH }}

            # Pull the latest changes from the main branch
            git pull origin main

            # Activate your virtual environment
            source venv/bin/activate

            # Install or update Python packages
            pip install -r requirements.txt

            # Run database migrations
            python manage.py migrate

            # Collect static files
            python manage.py collectstatic --noinput

            # Restart the application server to apply changes
            sudo supervisorctl restart caelium